<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SchulensteinChat</title>
  <style>
    :root{--bg1:#0d1b2a;--bg2:#1b263b;--accent:#00d1ff;--card:#14213d;--glass:rgba(255,255,255,0.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}

    /* Login */
    #loginScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
    .loginBox{width:360px;padding:28px;border-radius:16px;background:linear-gradient(180deg,var(--card),#0f1724);box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .loginBox h2{margin:0 0 12px}
    .field{width:100%;padding:12px;border-radius:10px;border:0;background:var(--glass);color:#fff;margin-top:10px}
    .btn{width:100%;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#042028;font-weight:700;margin-top:14px;cursor:pointer}

    /* App */
    #app{display:none;max-width:1000px;margin:28px auto;padding:18px}
    .messages{height:60vh;overflow:auto;background:rgba(255,255,255,.05);padding:12px;border-radius:10px}
    .msg{margin-bottom:10px;padding:10px;border-radius:8px;background:#1b263b}
    .controls{display:flex;gap:10px;margin-top:12px}
    .controls input{flex:1;padding:12px;border-radius:10px;border:0;background:var(--glass);color:#fff}
    .controls button{padding:12px 16px;border-radius:10px;border:0;background:var(--accent);font-weight:700}

    /* Admin */
    #adminModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
    .adminBox{background:#fff;color:#111;width:90%;max-width:700px;border-radius:12px;padding:16px}
    .adminItem{background:#f3f4f6;border-radius:8px;padding:10px;margin-bottom:8px}
  </style>
</head>
<body>

<div id="loginScreen">
  <div class="loginBox">
    <h2>SchulensteinChat</h2>
    <input id="username" class="field" placeholder="Ihr Name" />
    <input id="password" class="field" type="password" placeholder="Passwort" />
    <button class="btn" id="loginBtn">Einloggen</button>
    <p style="font-size:13px;opacity:.8">Name ist im Chat unsichtbar. Nur Admin sieht Namen.</p>
  </div>
</div>

<div id="app">
  <h1>SchulensteinChat</h1>

  <div class="messages" id="messages"></div>

  <div class="controls">
    <input id="text" placeholder="Nachricht schreiben..." />
    <button id="sendBtn">Senden</button>
  </div>

  <div style="margin-top:16px">
    <button id="buyAdmin" class="btn">Admin kaufen (1 CHF)</button>
    <div id="buyResult" style="margin-top:8px"></div>
    <button id="openAdmin" class="btn" style="display:none;background:#111;color:#fff">Admin Panel öffnen</button>
  </div>
</div>

<div id="adminModal">
  <div class="adminBox">
    <h3>Admin Panel</h3>
    <input id="adminPassword" class="field" type="password" placeholder="Admin Passwort" />
    <button id="adminLoginBtn" class="btn">Admin Login</button>
    <div id="adminList" style="margin-top:12px"></div>
    <button class="btn" onclick="closeAdmin()">Schließen</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyDxr-d1ZKp3wt3i289o6FKmevr3s8Uw3WA",authDomain:"okuler.firebaseapp.com",databaseURL:"https://okuler-default-rtdb.firebaseio.com",projectId:"okuler",storageBucket:"okuler.firebasestorage.app",messagingSenderId:"853942864718",appId:"1:853942864718:web:337671e3596467ae7e6c1f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const USER_PASS="Hogachat";
let ADMIN_PASS=null;
let USERNAME="";
let isAdmin=false;

loginBtn.onclick=()=>{
  if(password.value!==USER_PASS && password.value!==ADMIN_PASS)return alert("Falsches Passwort");
  USERNAME=username.value.trim();
  if(!USERNAME)return alert("Name fehlt");
  if(password.value===ADMIN_PASS)isAdmin=true;
  loginScreen.style.display="none";
  app.style.display="block";
  startChat();
};

function startChat(){
  db.ref("messages").limitToLast(100).on("value",snap=>{
    messages.innerHTML="";
    const v=snap.val();
    if(!v)return;
    Object.entries(v).forEach(([k,m])=>{
      const d=document.createElement("div");d.className="msg";
      d.innerHTML=`<div>${m.text}</div><div style="font-size:12px;opacity:.6">${new Date(m.time).toLocaleString("de-DE")}</div>`;
      messages.appendChild(d);
    });
  });
}

sendBtn.onclick=()=>{
  if(!text.value)return;
  db.ref("messages").push({text:text.value,name:USERNAME,time:Date.now()});
  text.value="";
};

buyAdmin.onclick = async () => {
  // Render sunucuna istek atıyoruz (localhost YOK)
  const r = await fetch("https://schulensteinchat-server.onrender.com/create-payment", {
    method: "POST"
  });
  const d = await r.json();
  location.href = d.url; // Stripe checkout'a yönlendirir
};

openAdmin.onclick=()=>adminModal.style.display="flex";
function closeAdmin(){adminModal.style.display="none"}

adminLoginBtn.onclick=()=>{
  if(adminPassword.value!==ADMIN_PASS)return alert("Admin Passwort falsch");
  isAdmin=true;
  loadAdmin();
};

function loadAdmin(){
  adminList.innerHTML="";
  db.ref("messages").once("value").then(s=>{
    Object.entries(s.val()||{}).forEach(([k,m])=>{
      const d=document.createElement("div");d.className="adminItem";
      d.textContent=m.name+": "+m.text;
      adminList.appendChild(d);
    });
  });
}
</script>
</body>
</html>
