<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Hogachat</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b1d2a">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, push, onChildAdded, onValue,
  set, remove, get, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyDxr-d1ZKp3wt3i289o6FKmevr3s8Uw3WA",
  authDomain: "okuler.firebaseapp.com",
  databaseURL: "https://okuler-default-rtdb.firebaseio.com",
  projectId: "okuler"
});
const db = getDatabase(app);

let isAdmin = false;
let userName = "";
let userKey = "";
let lastMessageTime = 0;
let spamCount = 0;

/* LOGIN */
window.login = async () => {
  userName = name.value.trim();
  const pass = password.value.trim();
  if (!userName || !pass) return alert("Name und Passwort eingeben");

  if (pass === "mirhan5685") isAdmin = true;
  else if (pass === "Hogachat") isAdmin = false;
  else return alert("Falsches Passwort");

  if ((await get(ref(db, "banned/" + userName))).exists())
    return alert("Du wurdest gebannt.");

  loginBox.style.display = "none";
  chatBox.style.display = "flex";
  if (isAdmin) adminBtn.style.display = "block";

  userKey = Date.now().toString();
  const uRef = ref(db, "onlineUsers/" + userKey);
  set(uRef, userName);
  onDisconnect(uRef).remove();

  // ONLINE SAYISI (HERKES)
  onValue(ref(db, "onlineUsers"), snap => {
    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
    onlineCount.textContent = "Online: " + count;
  });

  loadMessages();
  if (isAdmin) loadAdminPanel();
};

/* SEND MESSAGE + AUTO SPAM BAN */
window.sendMessage = async () => {
  const now = Date.now();
  if (now - lastMessageTime < 1200) spamCount++;
  else spamCount = 0;

  if (spamCount >= 3) {
    set(ref(db, "banned/" + userName), true);
    alert("Automatisch gebannt (Spam).");
    location.reload();
    return;
  }

  lastMessageTime = now;
  const msg = message.value.trim();
  if (!msg) return;

  push(ref(db, "messages"), {
    text: msg,
    admin: isAdmin,
    time: now
  });
  message.value = "";
};

/* LOAD MESSAGES */
function loadMessages() {
  onChildAdded(ref(db, "messages"), snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.className = m.admin ? "msg adminMsg" : "msg";

    const t = new Date(m.time).toLocaleTimeString("de-DE", {
      hour: "2-digit", minute: "2-digit"
    });

    div.innerHTML = m.admin
      ? `<b>ğŸ‘‘ Mirhan</b> <span class="time">${t}</span><br>${m.text}`
      : `Anonym <span class="time">${t}</span><br>${m.text}`;

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
}

/* ADMIN PANEL */
window.openAdmin = () => adminPanel.style.display = "flex";
window.closeAdmin = () => adminPanel.style.display = "none";

function loadAdminPanel() {

  // ONLINE LIST (ADMIN)
  onValue(ref(db, "onlineUsers"), snap => {
    onlineList.innerHTML = "";
    if (!snap.exists()) return;
    Object.values(snap.val()).forEach(name => {
      onlineList.innerHTML += `<li>${name}</li>`;
    });
  });

  // MESSAGE STATS + DELETE
  onValue(ref(db, "messages"), snap => {
    msgList.innerHTML = "";
    const count = snap.exists() ? Object.keys(snap.val()).length : 0;
    msgCount.textContent = count;

    if (!snap.exists()) return;
    Object.entries(snap.val()).forEach(([key, val]) => {
      msgList.innerHTML += `
        <li>
          ${val.text}
          <button onclick="deleteMsg('${key}')">âŒ</button>
        </li>`;
    });
  });
}

window.deleteMsg = id => {
  if (confirm("Nachricht lÃ¶schen?"))
    remove(ref(db, "messages/" + id));
};

window.banUser = () => {
  const n = banName.value.trim();
  if (n) set(ref(db, "banned/" + n), true);
};

/* ENTER */
document.addEventListener("keydown", e => {
  if (e.key === "Enter" && document.activeElement === message) sendMessage();
});
</script>

<style>
body{
  margin:0;height:100vh;
  background:#0b1d2a;color:#fff;
  font-family:Segoe UI;
}
.box,.adminBox{
  background:rgba(0,0,0,.6);
  padding:20px;border-radius:16px;
}
#loginBox,#chatBox,#adminPanel{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
}
#chatBox,#adminPanel{display:none}
#messages{
  height:45vh;overflow-y:auto;
  background:rgba(0,0,0,.4);
  padding:10px;border-radius:10px;
}
.msg{margin-bottom:8px}
.adminMsg{background:rgba(255,215,0,.15);padding:6px;border-radius:8px}
.time{font-size:11px;opacity:.7}
button{padding:8px;border:none;border-radius:8px;background:#1e90ff;color:#fff}
#adminBtn{position:absolute;top:10px;right:10px;display:none}
.adminBox{width:90%;max-width:360px}
ul{padding-left:16px}
#statusBar{font-size:13px;margin-bottom:6px}
</style>
</head>

<body>

<button id="adminBtn" onclick="openAdmin()">âš™ï¸</button>

<div id="loginBox">
  <div class="box">
    <input id="name" placeholder="Name">
    <input id="password" type="password" placeholder="Passwort">
    <button onclick="login()">Einloggen</button>
  </div>
</div>

<div id="chatBox">
  <div class="box">
    <div id="statusBar">
      <span id="onlineCount">Online: 0</span>
    </div>
    <div id="messages"></div>
    <input id="message" placeholder="Nachricht">
    <button onclick="sendMessage()">Senden</button>
  </div>
</div>

<div id="adminPanel">
  <div class="adminBox">
    <h3>ğŸ‘‘ Admin Panel</h3>

    ğŸ“Š Nachrichten gesamt: <b id="msgCount">0</b>
    <hr>

    ğŸ“‹ Online Nutzer:
    <ul id="onlineList"></ul>

    <hr>

    âŒ Nachrichten lÃ¶schen:
    <ul id="msgList"></ul>

    <input id="banName" placeholder="Name bannen">
    <button onclick="banUser()">Bannen</button>
    <button onclick="closeAdmin()">SchlieÃŸen</button>
  </div>
</div>

</body>
</html>
